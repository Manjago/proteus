# Спецификация Ассемблера Proteus

> Документация для текстового ассемблера ISA v1.2

## Обзор

Ассемблер Proteus преобразует текстовый исходный код в машинный код (массив 32-битных инструкций), который можно загрузить как организм в симуляцию.

## Синтаксис

### Общий формат строки

```
[метка:] [инструкция [операнды]] [; комментарий]
```

- **Метка** — идентификатор, заканчивающийся двоеточием
- **Инструкция** — мнемоника (NOP, MOV, MOVI, и т.д.)
- **Операнды** — регистры, числа или метки, разделённые запятыми
- **Комментарий** — от `;` до конца строки (игнорируется)

### Примеры

```asm
; Это комментарий
start:                      ; Метка
    GETADDR R7              ; Инструкция с одним операндом
    MOVI R4, 14             ; Инструкция с регистром и числом
    JMPN R0, R4, loop       ; Инструкция со ссылкой на метку
    JMP start               ; Безусловный переход на метку
```

## Регистры

8 регистров общего назначения: `R0` - `R7`

Регистр указывается как `R` + цифра. Регистр не чувствителен к регистру: `R0`, `r0`, `R0` — эквивалентны.

## Числа

- **Десятичные:** `14`, `1000`, `2097151`
- **Отрицательные:** `-5`, `-12` (для смещений JMP)
- **Hex (raw words):** `0x0280000E` (см. раздел "Raw Words")

Диапазоны:
- **Immediate (MOVI):** 0 — 2,097,151 (21 бит, unsigned)
- **Offset (JMP/JMPZ/JMPN):** -131,072 — +131,071 (18 бит, signed)

## Метки

Метки — именованные адреса в коде. Используются для:
- Организации циклов
- Условных переходов
- Обхода данных (шаблонов)

### Определение метки

```asm
loop:           ; Метка "loop" указывает на следующую инструкцию
    COPY R5, R6
```

### Ссылка на метку

```asm
    JMP loop        ; Прыгнуть на метку "loop"
    JMPN R0, R4, loop   ; Условный переход на "loop"
```

### Forward References

Метки могут использоваться **до** их определения:

```asm
    JMP skip        ; Ссылка на метку, определённую ниже
    NOP
    NOP
skip:               ; Определение метки
    NOP
```

Ассемблер использует двухпроходную компиляцию для разрешения forward references.

## Инструкции

### Базовые

| Мнемоника | Операнды | Описание |
|-----------|----------|----------|
| `NOP` | — | No operation |
| `MOV` | `Rd, Rs` | `Rd = Rs` |
| `MOVI` | `Rd, imm` | `Rd = imm` (0-2,097,151) |
| `GETADDR` | `Rd` | `Rd = startAddr` (мой абсолютный адрес) |

### Арифметика

| Мнемоника | Операнды | Описание |
|-----------|----------|----------|
| `ADD` | `Ra, Rb` | `Ra = Ra + Rb` |
| `SUB` | `Ra, Rb` | `Ra = Ra - Rb` |
| `INC` | `Ra` | `Ra = Ra + 1` |
| `DEC` | `Ra` | `Ra = Ra - 1` |

### Память

| Мнемоника | Операнды | Описание |
|-----------|----------|----------|
| `LOAD` | `Rd, Roff` | `Rd = soup[startAddr + Roff]` |
| `STORE` | `Roff, Rs` | `soup[startAddr + Roff] = Rs` |

### Управление потоком

| Мнемоника | Операнды | Описание |
|-----------|----------|----------|
| `JMP` | `offset` или `label` | `IP = IP + offset` |
| `JMPZ` | `Rc, offset` или `label` | if `Rc == 0` then jump |
| `JMPN` | `Ra, Rb, offset` или `label` | if `Ra < Rb` then jump |

### Системные

| Мнемоника | Операнды | Описание |
|-----------|----------|----------|
| `COPY` | `Rs, Rd` | `soup[Rd] = soup[Rs]` (мутации!) |
| `ALLOCATE` | `Rsize, Raddr` | Выделить память |
| `SPAWN` | `Raddr, Rsize` | Создать организм |

### Продвинутые

| Мнемоника | Операнды | Описание |
|-----------|----------|----------|
| `SEARCH` | `Rs, Rt, Rl, Rf` | Поиск шаблона в памяти |

## Raw Words (прямое указание hex)

Для продвинутых сценариев можно указывать инструкции напрямую как 32-битные числа:

```asm
.word 0x0280000E    ; MOVI R4, 14 (стандартное кодирование)
.word 0x0280FFFE    ; MOVI R4, 14 с "солью" в резервных битах
```

### Применение

1. **Защита от паразитов:** Добавление "соли" в резервные биты делает инструкцию невидимой для SEARCH с фиксированным шаблоном

2. **Нестандартные инструкции:** Экспериментальные или недокументированные опкоды

3. **Данные внутри генома:** Константы, шаблоны для SEARCH

### Пример: защищённый организм

```asm
start:
    GETADDR R7
    .word 0x0280FFFE    ; MOVI R4, 14 с солью (паразит не найдёт!)
    ALLOCATE R4, R3
    ; ...
```

## Структура типичного организма

```asm
; ============================================
; Имя организма
; ============================================
; Описание и комментарии

; === Инициализация ===
start:
    GETADDR R7          ; Получить свой адрес
    MOVI R4, SIZE       ; Размер генома

; === Выделение памяти ===
    ALLOCATE R4, R3     ; R3 = адрес для потомка

; === Настройка указателей ===
    MOV R5, R7          ; R5 = src (мой код)
    MOV R6, R3          ; R6 = dst (потомок)
    MOVI R0, 0          ; R0 = счётчик

; === Цикл копирования ===
copy_loop:
    COPY R5, R6         ; Копировать (с мутацией!)
    INC R5
    INC R6
    INC R0
    JMPN R0, R4, copy_loop

; === Размножение ===
    SPAWN R3, R4
    MOVI R0, 0          ; Сброс счётчика
    JMP start           ; Повторить
```

## Данные внутри генома

Для хранения шаблонов, констант или оружия используйте метки и `JMP` для обхода:

```asm
    JMP after_data      ; Перепрыгнуть данные

template:
    MOVI R4, 14         ; Шаблон для SEARCH (не выполняется!)

weapon:
    NOP                 ; Чем перезаписывать врага

after_data:
    ; Код атаки использует template и weapon по их offset'ам
    MOVI R1, 5          ; R1 = offset template (от start)
    ; ...
```

## CLI использование

```bash
# Ассемблировать файл (создаёт .bin с тем же именем)
java -jar proteus.jar assemble myorg.asm

# Ассемблировать с указанием выходного файла
java -jar proteus.jar assemble myorg.asm -o output.bin

# Показать дизассемблирование после сборки
java -jar proteus.jar assemble myorg.asm -d

# Verbose режим
java -jar proteus.jar assemble myorg.asm -v
```

## Ошибки компиляции

| Ошибка | Описание |
|--------|----------|
| `Unknown instruction: XXX` | Неизвестная мнемоника |
| `Invalid register: XXX` | Неверный регистр (ожидается R0-R7) |
| `Undefined label: XXX` | Ссылка на несуществующую метку |
| `Duplicate label: XXX` | Метка определена дважды |
| `Immediate out of range` | Число > 2,097,151 для MOVI |
| `Offset out of range` | Смещение > ±131,071 для JMP |
| `Not enough operands` | Недостаточно аргументов |

## Примеры

См. каталог `examples/`:
- `adam.asm` — базовый самовоспроизводящийся организм
- `parasite.asm` — организм-паразит с SEARCH
