# Proteus: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

> –î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –∫–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–µ–∫—Ç–∞.
> –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å –∫–æ–¥–æ–º.

## 1. –û–±–∑–æ—Ä

**Proteus** ‚Äî —Å–∏–º—É–ª—è—Ü–∏—è –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–π –∂–∏–∑–Ω–∏, –≤–¥–æ—Ö–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–æ–π [Tierra](https://en.wikipedia.org/wiki/Tierra_(computer_simulation)) –¢–æ–º–∞—Å–∞ –†—ç—è (1991).

–û—Ä–≥–∞–Ω–∏–∑–º—ã ‚Äî —ç—Ç–æ —Å–∞–º–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—â–∏–µ—Å—è –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∂–∏–≤—É—â–∏–µ –≤ –æ–±—â–µ–π –ø–∞–º—è—Ç–∏ ("—Å—É–ø–µ"). –û–Ω–∏ –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—Ç –∑–∞ —Ä–µ—Å—É—Ä—Å—ã (–ø–∞–º—è—Ç—å, CPU-–≤—Ä–µ–º—è), –º—É—Ç–∏—Ä—É—é—Ç –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏ —ç–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä—É—é—Ç.

### –¶–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞

- –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã Tierra –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å—Ç–µ–∫–µ (Java 21+)
- –ù–∞–±–ª—é–¥–∞—Ç—å —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–µ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ –ø–∞—Ä–∞–∑–∏—Ç–æ–≤, –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–∑–∏—Ç–æ–≤ –∏ —ç–∫–æ—Å–∏—Å—Ç–µ–º
- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —ç–≤–æ–ª—é—Ü–∏–∏

### –û—Ç–ª–∏—á–∏—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π Tierra

| –ê—Å–ø–µ–∫—Ç | Tierra (1991) | Proteus |
|--------|---------------|---------|
| –Ø–∑—ã–∫ | C | Java 21+ |
| ISA | 32 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ | 17 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π (ISA v1.2) |
| –ê–¥—Ä–µ—Å–∞—Ü–∏—è | Template-based | –ü—Ä—è–º–∞—è + Template (SEARCH) |
| –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã | –¢–æ–ª—å–∫–æ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ | MOVI (21-bit immediate) |
| –ö–æ–¥ | –ê–±—Å–æ–ª—é—Ç–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ | Position-Independent (v1.2) |

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      CLI (picocli)                          ‚îÇ
‚îÇ              run | disassemble | ancestor | info            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  SimulatorConfig (HOCON)  ‚îÇ  SimulatorListener (events)     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ                    Simulator                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - run(), stop(), seedAdam()                        ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - aliveOrganisms[], organisms[]                    ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - MutationTracker, Defragmenter                    ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ         ‚îÇ                      ‚îÇ                    ‚îÇ       ‚îÇ
‚îÇ         ‚ñº                      ‚ñº                    ‚ñº       ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ    ‚îÇ  VirtualCPU ‚îÇ    ‚îÇ   Reaper    ‚îÇ    ‚îÇ MemoryMgr   ‚îÇ    ‚îÇ
‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ
‚îÇ    ‚îÇ - execute() ‚îÇ    ‚îÇ - reap()    ‚îÇ    ‚îÇ - allocate()‚îÇ    ‚îÇ
‚îÇ    ‚îÇ - mutations ‚îÇ    ‚îÇ - lazy del  ‚îÇ    ‚îÇ - free()    ‚îÇ    ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ - rebuild() ‚îÇ    ‚îÇ
‚îÇ           ‚îÇ                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ           ‚ñº                                                 ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ    ‚îÇ  CpuState   ‚îÇ    ‚îÇ  Organism   ‚îÇ    ‚îÇDefragmenter ‚îÇ    ‚îÇ
‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ
‚îÇ    ‚îÇ - regs[8]   ‚îÇ    ‚îÇ - id, addr  ‚îÇ    ‚îÇ - compact() ‚îÇ    ‚îÇ
‚îÇ    ‚îÇ - IP (rel)  ‚îÇ    ‚îÇ - size      ‚îÇ    ‚îÇ - 2-pass    ‚îÇ    ‚îÇ
‚îÇ    ‚îÇ - startAddr ‚îÇ    ‚îÇ - alive     ‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ
‚îÇ    ‚îÇ - pending   ‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                     AtomicIntegerArray                      ‚îÇ
‚îÇ                    "Soup" (10K-1M cells)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–ª–∞—Å—Å—ã

#### Core (—è–¥—Ä–æ —Å–∏–º—É–ª—è—Ü–∏–∏)

| –ö–ª–∞—Å—Å | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å |
|-------|-----------------|
| `OpCode` | Enum –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π + encoding/decoding |
| `CpuState` | –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ (—Ä–µ–≥–∏—Å—Ç—Ä—ã, IP, startAddr, pending allocation) |
| `VirtualCPU` | –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, –º—É—Ç–∞—Ü–∏–∏ –ø—Ä–∏ COPY |
| `SystemCallHandler` | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è ALLOCATE, SPAWN, freePending |
| `Organism` | –û—Ä–≥–∞–Ω–∏–∑–º: –≥–µ–Ω–æ–º, —Å–æ—Å—Ç–æ—è–Ω–∏–µ, lifecycle |
| `MemoryManager` | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é (allocate/free/rebuild) |
| `FreeListMemoryManager` | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: Free List + First Fit + Coalesce |
| `Reaper` | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∂–Ω–µ—Ü–∞ (—É–±–∏–π—Å—Ç–≤–æ + –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ) |
| `AgeBasedReaper` | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: lazy deletion, —É–±–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä–µ–π—à–∏—Ö |
| `Defragmenter` | –ö–æ–º–ø–∞–∫—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ (two-pass algorithm) |
| `MutationTracker` | –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º—É—Ç–∞—Ü–∏–π –ø—Ä–∏ COPY |
| `Disassembler` | –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –≤ –º–Ω–µ–º–æ–Ω–∏–∫–∏ |
| `GenomeBuilder` | Fluent API –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥–µ–Ω–æ–º–æ–≤ |
| `Adam` | –ü–µ—Ä–≤—ã–π —Å–∞–º–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—â–∏–π—Å—è –æ—Ä–≥–∞–Ω–∏–∑–º (14 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, v3) |

#### Application (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)

| –ö–ª–∞—Å—Å | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å |
|-------|-----------------|
| `SimulatorConfig` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (HOCON, typesafe-config) |
| `Simulator` | –ì–ª–∞–≤–Ω—ã–π –¥–≤–∏–∂–æ–∫ —Å–∏–º—É–ª—è—Ü–∏–∏ |
| `SimulatorStats` | –°–Ω–∏–º–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–≤–∫–ª—é—á–∞—è memoryLeak, maxAlive) |
| `SimulatorListener` | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ–±—ã—Ç–∏–π (spawn, death, checkpoint) |
| `DeathCause` | Enum –ø—Ä–∏—á–∏–Ω —Å–º–µ—Ä—Ç–∏ (ERRORS, REAPED) |

#### CLI (–∫–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞)

| –ö–ª–∞—Å—Å | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å |
|-------|-----------------|
| `ProteusCli` | –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (picocli) |
| `RunCommand` | –ö–æ–º–∞–Ω–¥–∞ `run` ‚Äî –∑–∞–ø—É—Å–∫ —Å–∏–º—É–ª—è—Ü–∏–∏ |
| `DisassembleCommand` | –ö–æ–º–∞–Ω–¥–∞ `disassemble` ‚Äî –¥–∏–∑–∞—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ |
| `AncestorCommand` | –ö–æ–º–∞–Ω–¥–∞ `ancestor` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≥–µ–Ω–æ–º Adam |
| `InfoCommand` | –ö–æ–º–∞–Ω–¥–∞ `info` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ |

---

## 3. –ù–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π (ISA v1.2)

–ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: [ISA_SPEC.md](ISA_SPEC.md)

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ v1.2 (Position-Independent Code)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | v1.1 | v1.2 |
|-----------|------|------|
| **JMP/JMPZ/JMPN** | –ê–±—Å–æ–ª—é—Ç–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ö | IP-relative offset (18-bit signed) |
| **LOAD/STORE** | –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –∞–¥—Ä–µ—Å–∞—Ü–∏—è | startAddr-relative (—Å–≤–æ—è –ø–∞–º—è—Ç—å) |
| **GETADDR** | ‚Äî | –ù–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π startAddr |
| **Adam** | 13 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ JMP | 14 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, position-independent |

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ PIC

1. **–î–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è** ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–º—ã –º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –≤ –ø–∞–º—è—Ç–∏ –±–µ–∑ –ø–∞—Ç—á–∏–Ω–≥–∞ –∫–æ–¥–∞
2. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å** ‚Äî –ø–æ—Ç–æ–º–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –ª—é–±–æ–≥–æ –∞–¥—Ä–µ—Å–∞
3. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** ‚Äî –Ω–µ –Ω—É–∂–Ω—ã —Ä–µ–ª–æ–∫–∞—Ü–∏–∏ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏

### –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ |
|-----------|------------|
| –ë–∞–∑–æ–≤—ã–µ | `NOP`, `MOV`, `MOVI`, `GETADDR` |
| –ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞ | `ADD`, `SUB`, `INC`, `DEC` |
| –ü–∞–º—è—Ç—å (relative) | `LOAD`, `STORE` |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (IP-relative) | `JMP offset`, `JMPZ R, offset`, `JMPN Ra, Rb, offset` |
| –°–∏—Å—Ç–µ–º–Ω—ã–µ (absolute) | `COPY`, `ALLOCATE`, `SPAWN` |
| –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ | `SEARCH` |

### –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (32 –±–∏—Ç–∞):**
```
[8 bits: OpCode | 3 bits: R1 | 3 bits: R2 | 3 bits: R3 | 3 bits: R4 | 12 bits: reserved]
```

**–§–æ—Ä–º–∞—Ç MOVI:**
```
[8 bits: OpCode | 3 bits: R_dst | 21 bits: immediate (unsigned)]
```

**–§–æ—Ä–º–∞—Ç JMP/JMPZ/JMPN (v1.2):**
```
[8 bits: OpCode | 3 bits: R_cond1 | 3 bits: R_cond2 | 18 bits: offset (signed)]
```

---

## 4. –ü—Ä–∏–Ω—Ü–∏–ø—ã –∏ –¥–∏–∑–∞–π–Ω-—Ä–µ—à–µ–Ω–∏—è

### 4.1. –ú—É—Ç–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ COPY ‚úÖ

**–†–µ—à–µ–Ω–∏–µ:** –ú—É—Ç–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –¢–û–õ–¨–ö–û –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ `COPY`.

**–ü–æ—á–µ–º—É:**
- –ë–∏–æ–ª–æ–≥–∏—á–Ω–µ–µ ‚Äî –º—É—Ç–∞—Ü–∏–∏ –≤ –ø—Ä–∏—Ä–æ–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –ø—Ä–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –î–ù–ö
- –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–µ–µ ‚Äî –ª–µ–≥—á–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –∏ –ø–æ–Ω–∏–º–∞—Ç—å
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ ‚Äî –Ω–µ –Ω—É–∂–µ–Ω —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –º—É—Ç–∞—Ü–∏–π

```java
// VirtualCPU.java
case COPY -> {
    int value = memory.get(srcAddr);
    if (random.nextDouble() < mutationRate) {
        value = mutate(value);  // ‚Üê –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ –º—É—Ç–∞—Ü–∏–π!
    }
    memory.set(dstAddr, value);
}
```

### 4.2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –ø–∞–º—è—Ç–∏ ‚úÖ

**–†–µ—à–µ–Ω–∏–µ:** –û—Ä–≥–∞–Ω–∏–∑–º—ã –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å –õ–Æ–ë–£–Æ —è—á–µ–π–∫—É –ø–∞–º—è—Ç–∏.

**–ü–æ—á–µ–º—É —ç—Ç–æ –§–ò–ß–ê, –∞ –Ω–µ –±–∞–≥:**
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ **–ø–∞—Ä–∞–∑–∏—Ç–æ–≤** (–∏—Å–ø–æ–ª—å–∑—É—é—Ç —á—É–∂–æ–π –∫–æ–¥)
- –ü–æ–∑–≤–æ–ª—è–µ—Ç **—Ö–∏—â–Ω–∏—á–µ—Å—Ç–≤–æ** (–ø–æ—Ä—Ç—è—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤)
- –°–æ–∑–¥–∞—ë—Ç **—ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ** –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –¥–∏–Ω–∞–º–∏–∫—É
- –¢–∞–∫ –±—ã–ª–æ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π Tierra

### 4.3. Round-Robin –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ ‚úÖ

**–†–µ—à–µ–Ω–∏–µ:** –ö–∞–∂–¥—ã–π –æ—Ä–≥–∞–Ω–∏–∑–º –ø–æ–ª—É—á–∞–µ—Ç —Ä–æ–≤–Ω–æ 1 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∑–∞ —Ü–∏–∫–ª.

**–ü–æ—á–µ–º—É:**
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –ß–µ—Å—Ç–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ CPU
- –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å (–≤–∞–∂–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)

### 4.4. –°–º–µ—Ä—Ç—å –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ—à–∏–±–æ–∫ ‚úÖ

**–†–µ—à–µ–Ω–∏–µ:** –û—Ä–≥–∞–Ω–∏–∑–º —É–º–∏—Ä–∞–µ—Ç –ø–æ—Å–ª–µ 100 –æ—à–∏–±–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

**–¢–∏–ø—ã –æ—à–∏–±–æ–∫:**
- `ERROR_IP_OUT_OF_BOUNDS` ‚Äî IP –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –ø–∞–º—è—Ç–∏
- `ERROR_UNKNOWN_OPCODE` ‚Äî –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- `ERROR_MEMORY_OUT_OF_BOUNDS` ‚Äî —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏

### 4.5. Pending Allocation Tracking ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –ø—Ä–∏:
- –î–≤–æ–π–Ω–æ–º ALLOCATE –±–µ–∑ SPAWN –º–µ–∂–¥—É –Ω–∏–º–∏
- –°–º–µ—Ä—Ç–∏ –æ—Ä–≥–∞–Ω–∏–∑–º–∞ –¥–æ SPAWN
- SPAWN —Å –º—É—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∞–¥—Ä–µ—Å–æ–º/—Ä–∞–∑–º–µ—Ä–æ–º

**–†–µ—à–µ–Ω–∏–µ:** CpuState –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç pending allocation:

```java
// CpuState
private int pendingAllocAddr = -1;
private int pendingAllocSize = 0;

// –ü—Ä–∏ ALLOCATE
if (hasPendingAllocation()) {
    syscallHandler.freePending(pendingAddr, pendingSize);  // –û—Å–≤–æ–±–æ–¥–∏—Ç—å —Å—Ç–∞—Ä—ã–π!
}
state.setPendingAllocation(addr, size);

// –ü—Ä–∏ SPAWN
if (address != pendingAddr) {
    reject + free pending;  // –ú—É—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å!
}
actualSize = pendingSize;  // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –Ω–µ –º—É—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π

// –ü—Ä–∏ —Å–º–µ—Ä—Ç–∏
if (state.hasPendingAllocation()) {
    memoryManager.free(pendingAddr, pendingSize);
}
```

### 4.6. Lazy Deletion –≤ Reaper ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** `PriorityQueue.remove()` = O(n) ‚Äî —É–±–∏–π—Å—Ç–≤–µ–Ω–Ω–æ –ø—Ä–∏ –º–∏–ª–ª–∏–æ–Ω–∞—Ö –æ—Ä–≥–∞–Ω–∏–∑–º–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:** –ù–µ —É–¥–∞–ª—è–µ–º –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –ø—Ä–∏ unregister(), –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º—ë—Ä—Ç–≤—ã—Ö –ø—Ä–∏ reap():

```java
public void unregister(Organism org) {
    // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º! Lazy deletion.
}

public Organism reap() {
    while (!queue.isEmpty()) {
        Organism candidate = queue.poll();
        if (candidate.isAlive()) {  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –º—ë—Ä—Ç–≤—ã—Ö
            // Kill and return
        }
    }
}
```

**–ö–æ–º–ø—Ä–æ–º–∏—Å—Å:**
- ‚úÖ unregister(): O(n) ‚Üí O(1)
- ‚ö†Ô∏è Queue —Ä–∞—Å—Ç—ë—Ç —Å –º—ë—Ä—Ç–≤—ã–º–∏ –æ—Ä–≥–∞–Ω–∏–∑–º–∞–º–∏ (–ø–∞–º—è—Ç—å!)
- üìã TODO: periodic cleanup –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –º—ë—Ä—Ç–≤—ã—Ö

---

## 5. Adam ‚Äî –ø–µ—Ä–≤—ã–π –æ—Ä–≥–∞–Ω–∏–∑–º

Adam ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–∞–º–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—â–∏–π—Å—è –æ—Ä–≥–∞–Ω–∏–∑–º. –≠—Ç–æ "–ø—Ä–µ–¥–æ–∫", –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ —ç–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ.

### –ì–µ–Ω–æ–º v3 (14 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, Position-Independent)

```asm
; –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
0000: MOVI R4, 14       ; R4 = SIZE
0001: GETADDR R7        ; R7 = –º–æ–π –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –∞–¥—Ä–µ—Å

; –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
0002: ALLOCATE R4, R3   ; R3 = –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ—Ç–æ–º–∫–∞

; –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É–∫–∞–∑–∞—Ç–µ–ª–µ–π
0003: MOV R5, R7        ; R5 = src pointer (–º–æ–π —Å—Ç–∞—Ä—Ç)
0004: MOV R6, R3        ; R6 = dst pointer (—Å—Ç–∞—Ä—Ç –ø–æ—Ç–æ–º–∫–∞)
0005: MOVI R0, 0        ; R0 = counter

; –¶–∏–∫–ª –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–∞–¥—Ä–µ—Å 6)
0006: COPY [R5], [R6]   ; –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å –º—É—Ç–∞—Ü–∏–µ–π!
0007: INC R5            ; src++
0008: INC R6            ; dst++
0009: INC R0            ; counter++
000A: JMPN R0, R4, -5   ; if counter < SIZE, goto 6

; –ü–æ—Ä–æ–∂–¥–µ–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä
000B: SPAWN R3, R4      ; –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–º–∫–∞
000C: MOVI R0, 0        ; Reset counter
000D: JMP -12           ; goto 2 (ALLOCATE)
```

### –†–µ–≥–∏—Å—Ç—Ä—ã (v3)

| –†–µ–≥–∏—Å—Ç—Ä | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|------------|
| R0 | Counter (0 to size-1) |
| R3 | –ê–¥—Ä–µ—Å –ø–æ—Ç–æ–º–∫–∞ (–æ—Ç ALLOCATE) |
| R4 | –†–∞–∑–º–µ—Ä –≥–µ–Ω–æ–º–∞ (14) |
| R5 | Source pointer (–∞–±—Å–æ–ª—é—Ç–Ω—ã–π, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è) |
| R6 | Destination pointer (–∞–±—Å–æ–ª—é—Ç–Ω—ã–π, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è) |
| R7 | –ú–æ–π startAddr (–æ—Ç GETADDR) |

---

## 6. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

### 6.1. MemoryManager

**–ê–ª–≥–æ—Ä–∏—Ç–º: Free List + First Fit + Coalesce**

| –ú–µ—Ç–æ–¥ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|-----------|----------|
| `allocate(size)` | O(n) | First Fit ‚Äî –ø–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π –±–ª–æ–∫ |
| `free(addr, size)` | O(n) | –î–æ–±–∞–≤–∏—Ç—å + —Å–ª–∏—Ç—å —Å–æ—Å–µ–¥–Ω–∏–µ |
| `rebuild(usedEnd)` | O(1) | –û—á–∏—Å—Ç–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –æ–¥–∏–Ω –±–ª–æ–∫ (–¥–ª—è –¥–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏) |
| `getFreeMemory()` | O(n) | –°—É–º–º–∞ –≤—Å–µ—Ö —Å–≤–æ–±–æ–¥–Ω—ã—Ö –±–ª–æ–∫–æ–≤ |
| `getLargestFreeBlock()` | O(n) | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –±–ª–æ–∫ |
| `getFragmentation()` | O(n) | 1 - (largest / total) |

### 6.2. –§—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è

**–ú–µ—Ç—Ä–∏–∫–∞:**
```
fragmentation = 1 - (largestFreeBlock / totalFreeMemory)
```
- 0.0 = –≤—Å—è —Å–≤–æ–±–æ–¥–Ω–∞—è –ø–∞–º—è—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞
- 0.9 = 90% —Å–≤–æ–±–æ–¥–Ω–æ–π –ø–∞–º—è—Ç–∏ –≤ –º–µ–ª–∫–∏—Ö –¥—ã—Ä–∞—Ö

### 6.3. –î–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è (Defragmenter)

**–¢—Ä–∏–≥–≥–µ—Ä:** `fragmentation > 50% AND largestFree < minRequired`

**–ê–ª–≥–æ—Ä–∏—Ç–º (Two-Pass, All-or-Nothing):**

```
PASS 1: –í–∞–ª–∏–¥–∞—Ü–∏—è
  for each organism:
    if invalid (size <= 0 or > 1000): ABORT
    totalSize += size
  if totalSize > soupSize: ABORT

PASS 2: –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ Pass 1 —É—Å–ø–µ—à–µ–Ω)
  sort organisms by startAddr
  nextFreeAddr = 0
  for each organism:
    if oldAddr != nextFreeAddr:
      copy genome from oldAddr to nextFreeAddr
      organism.setStartAddr(nextFreeAddr)
    nextFreeAddr += size
  
  memoryManager.rebuild(nextFreeAddr)  // –û–¥–∏–Ω —Å–≤–æ–±–æ–¥–Ω—ã–π –±–ª–æ–∫ –≤ –∫–æ–Ω—Ü–µ
```

**–ü–æ—á–µ–º—É Two-Pass:**
- Partial defrag –ª–æ–º–∞–ª free list (moved organisms, –Ω–æ –Ω–µ rebuild)
- "–í—Å—ë –∏–ª–∏ –Ω–∏—á–µ–≥–æ" –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**Position-Independence –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:**
- IP –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º (–Ω–µ –Ω—É–∂–Ω–æ –ø–∞—Ç—á–∏—Ç—å)
- JMP/JMPZ/JMPN –∏—Å–ø–æ–ª—å–∑—É—é—Ç offset'—ã
- GETADDR –¥–∞—Å—Ç –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è

---

## 7. Reaper (–ñ–Ω–µ—Ü)

### 7.1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

Reaper ‚Äî –º–µ—Ö–∞–Ω–∏–∑–º "—Å–º–µ—Ä—Ç–∏ –æ—Ç —Å—Ç–∞—Ä–æ—Å—Ç–∏":
- –£–±–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã—Ö/–Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–º–æ–≤
- –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –∏—Ö –ø–∞–º—è—Ç—å + pending allocation
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫—Ä—É–≥–æ–≤–æ—Ä–æ—Ç –ø–æ–∫–æ–ª–µ–Ω–∏–π

### 7.2. –ê–ª–≥–æ—Ä–∏—Ç–º (Age-Based + Lazy Deletion)

```java
public Organism reap() {
    while (!queue.isEmpty()) {
        Organism candidate = queue.poll();
        if (candidate.isAlive()) {
            candidate.kill();
            // Free pending allocation if any
            if (state.hasPendingAllocation()) {
                memoryManager.free(pendingAddr, pendingSize);
            }
            memoryManager.free(org.addr, org.size);
            return candidate;
        }
        // Skip dead organisms (lazy deletion)
    }
    return null;
}

public int reapUntilFree(int size) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –∫–æ–≥–¥–∞ totalFree >= size (–¥–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å)
    // –ù–ï –∫–æ–≥–¥–∞ largestFree >= size (—ç—Ç–æ —É–±–∏–≤–∞–ª–æ –≤—Å–µ—Ö!)
    while (getFreeMemory() < size && !queue.isEmpty()) {
        reap();
    }
}
```

### 7.3. –¢—Ä–∏–≥–≥–µ—Ä—ã

| –¢—Ä–∏–≥–≥–µ—Ä | –ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç |
|---------|-------------------|
| **–ü–æ –ø–∞–º—è—Ç–∏** | `allocate()` –≤–µ—Ä–Ω—É–ª -1, `totalFree < size` |
| **–ü–æ –ø–æ–ø—É–ª—è—Ü–∏–∏** | `aliveCount >= maxOrganisms` |

---

## 8. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### SimulatorStats

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `totalCycles` | –í—Å–µ–≥–æ —Ü–∏–∫–ª–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ |
| `totalSpawns` | –£—Å–ø–µ—à–Ω—ã—Ö SPAWN |
| `rejectedSpawns` | –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã—Ö SPAWN (invalid addr/size) |
| `deathsByErrors` | –°–º–µ—Ä—Ç–µ–π –æ—Ç –æ—à–∏–±–æ–∫ |
| `deathsByReaper` | –°–º–µ—Ä—Ç–µ–π –æ—Ç –∂–Ω–µ—Ü–∞ |
| `aliveCount` | –ñ–∏–≤—ã—Ö —Å–µ–π—á–∞—Å |
| `maxAlive` | –ü–∏–∫–æ–≤–∞—è –ø–æ–ø—É–ª—è—Ü–∏—è |
| `memoryUsed` | –ó–∞–Ω—è—Ç–æ –ø–∞–º—è—Ç–∏ |
| `memoryLeak` | –£—Ç–µ—á–∫–∞: used - expected |
| `fragmentation` | –§—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è (0.0-1.0) |
| `defragmentations` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–π |
| `totalMutations` | –í—Å–µ–≥–æ –º—É—Ç–∞—Ü–∏–π |

### Memory Leak Detection

```java
int getExpectedMemoryUsed() {
    int expected = 0;
    for (Organism org : aliveOrganisms) {
        expected += org.getSize();
        if (state.hasPendingAllocation()) {
            expected += state.getPendingAllocSize();
        }
    }
    return expected;
}

int getMemoryLeak() {
    return memoryManager.getUsedMemory() - getExpectedMemoryUsed();
}
```

–ï—Å–ª–∏ `memoryLeak > 0` –ø—Ä–∏ `aliveCount = 0` ‚Äî –µ—Å—Ç—å —É—Ç–µ—á–∫–∞!

---

## 9. –ù–∞–±–ª—é–¥–∞–µ–º—ã–µ —Ñ–µ–Ω–æ–º–µ–Ω—ã

### 9.1. –ú—É—Ç–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –≥–µ–Ω–æ–º–∞

**–§–µ–Ω–æ–º–µ–Ω:** `MOVI R4, 14` –º—É—Ç–∏—Ä—É–µ—Ç –≤ `MOVI R4, 270` ‚Üí –æ—Ä–≥–∞–Ω–∏–∑–º —Å size=270!

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ó–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏ (270 vs 14 cells)
- –ü—Ä–∏ –¥–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –º–æ–∂–µ—Ç –Ω–µ –ø–æ–º–µ—Å—Ç–∏—Ç—å—Å—è
- –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ —ç–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–æ ‚Äî —ç—Ç–æ "—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≥–µ–Ω–æ–º–∞"

### 9.2. Population Bottleneck

**–§–µ–Ω–æ–º–µ–Ω:** –ü–æ–ø—É–ª—è—Ü–∏—è 5000 ‚Üí 2 –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç—ã—Å—è—á —Ü–∏–∫–ª–æ–≤.

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –ª–µ—Ç–∞–ª—å–Ω—ã—Ö –º—É—Ç–∞—Ü–∏–π
- –§—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ
- –í—ã–∂–∏–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ "—á–∏—Å—Ç—ã–µ" –∏–ª–∏ —É–¥–∞—á–Ω–æ –º—É—Ç–∏—Ä–æ–≤–∞–≤—à–∏–µ

### 9.3. –ó–∞—Å—Ç–æ–π (Stasis)

**–§–µ–Ω–æ–º–µ–Ω:** spawns –∑–∞—Å—Ç—ã–≤–∞—é—Ç, –ø–æ–ø—É–ª—è—Ü–∏—è –º–µ–¥–ª–µ–Ω–Ω–æ —É–º–∏—Ä–∞–µ—Ç –æ—Ç –æ—à–∏–±–æ–∫.

**–ü—Ä–∏—á–∏–Ω–∞:** –í—Å–µ –∂–∏–≤—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–º—ã –∏–º–µ—é—Ç –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–π –∫–æ–¥, –Ω–µ –º–æ–≥—É—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–Ω–æ–∂–∞—Ç—å—Å—è.

---

## 10. CLI –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ö–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞

```bash
# –°–±–æ—Ä–∫–∞
mvn clean package

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ wrapper (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
./sim.sh [options]

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é —Å –ª–∏–º–∏—Ç–æ–º –ø–∞–º—è—Ç–∏ (512MB ‚Äî VPS-—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ)
java -Xmx512m -XX:+UseG1GC -jar target/proteus-1.0.0-SNAPSHOT.jar run [options]

# –û–ø—Ü–∏–∏ run:
#   -c, --cycles         Max cycles (0 = infinite)
#   -s, --soup-size      Soup size (memory cells)
#   -m, --mutation-rate  Mutation rate (0.0-1.0)
#   --seed               Random seed for reproducibility
#   --max-organisms      Maximum living organisms
#   -q, --quiet          Quiet mode

# –ü—Ä–∏–º–µ—Ä—ã
java -jar proteus.jar run -c 5000000 -s 100000 --max-organisms 5000
java -jar proteus.jar run --seed 12345  # –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π –∑–∞–ø—É—Å–∫

# –î—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã
java -jar proteus.jar disassemble <file>
java -jar proteus.jar ancestor
java -jar proteus.jar info
```

### –≠–º–ø–∏—Ä–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

#### Mutation Rate

| Rate | –†–µ–∂–∏–º | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|------|-------|-----------|
| 0.1% | –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π | –°—Ç–∞–±–∏–ª—å–Ω–æ, –º–∞–ª–æ —ç–≤–æ–ª—é—Ü–∏–∏ |
| **0.2%** | **–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π** | –ë–∞–ª–∞–Ω—Å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ —ç–≤–æ–ª—é—Ü–∏–∏ |
| 0.5%+ | Error catastrophe | –í—ã–º–∏—Ä–∞–Ω–∏–µ |

#### –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ soup/organisms

**–§–æ—Ä–º—É–ª–∞:** `max_organisms ‚âà soup_size / avg_genome_size * 0.7`

| Soup size | Max organisms |
|-----------|---------------|
| 100K | 5,000 |
| 1M | 50,000 |

---

## 11. Roadmap

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (Stage 1-3: Core + Application)

- [x] ISA v1.1 ‚Üí v1.2 (Position-Independent Code)
- [x] VirtualCPU —Å –º—É—Ç–∞—Ü–∏—è–º–∏
- [x] Adam v3 (14 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, PIC)
- [x] MemoryManager (Free List + First Fit + Coalesce)
- [x] Reaper (Age-Based + Lazy Deletion)
- [x] Simulator + CLI (picocli)
- [x] Graceful shutdown, random seed
- [x] MutationTracker

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (Stage 3.5-3.6: PIC + Defragmentation)

- [x] GETADDR instruction
- [x] IP-relative JMP/JMPZ/JMPN
- [x] startAddr-relative LOAD/STORE
- [x] Defragmenter (two-pass, all-or-nothing)
- [x] Pending allocation tracking
- [x] Memory leak detection
- [x] Performance: O(1) unregister (lazy deletion)
- [x] Performance: O(alive) parent search

### üöß –í —Ä–∞–±–æ—Ç–µ (Stage 4: Cleanup & Persistence)

- [ ] **Reaper Queue Cleanup** ‚Äî –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –º—ë—Ä—Ç–≤—ã—Ö –∏–∑ –æ—á–µ—Ä–µ–¥–∏ (lazy deletion –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –º—É—Å–æ—Ä)
- [ ] **PersistenceManager** ‚Äî H2 MVStore –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- [ ] **EventLogger** ‚Äî –∂—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π (JSON Lines)
- [ ] **Checkpoints** ‚Äî –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- [ ] –ö–æ–º–∞–Ω–¥–∞ `resume` ‚Äî –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å checkpoint'–∞
- [ ] –ö–æ–º–∞–Ω–¥–∞ `analyze` ‚Äî –∞–Ω–∞–ª–∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

### üìã –ü–ª–∞–Ω—ã (Stage 5+)

- [ ] Genealogy tracking (—Ä–æ–¥–æ—Å–ª–æ–≤–Ω—ã–µ)
- [ ] Diversity metrics
- [ ] Web UI –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- [ ] Export –≤ CSV/JSON

---

## –°—Å—ã–ª–∫–∏

- [Tierra (Wikipedia)](https://en.wikipedia.org/wiki/Tierra_(computer_simulation))
- [Avida](https://en.wikipedia.org/wiki/Avida) ‚Äî —Ä–∞–∑–≤–∏—Ç–∏–µ –∏–¥–µ–π Tierra
- [ISA_SPEC.md](ISA_SPEC.md) ‚Äî –ø–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
